#!/bin/bash
# Pterodactyl Full Auto Installer
# Panel + Wings + MySQL fix + Auto IP + TLS + Firewall + Clean

set -euo pipefail
IFS=$'\n\t'

# ---------------- Config ----------------
GITHUB_INSTALLER_URL="https://raw.githubusercontent.com/itsnaruto045-hub/Pterodactyl/main/installer"
LOG_PATH="/var/log/pterodactyl_auto_installer.log"
AUTO_YES=1
DO_CLEAN=1
DB_USER="pterodactyl"
DB_PASS="PteroPass123!"
BANNER_SPEED=0.002

# ---------------- Helpers ----------------
info(){ printf "\033[1;34m[*]\033[0m %s\n" "$*"; }
ok(){ printf "\033[1;32m[+]\033[0m %s\n" "$*"; }
warn(){ printf "\033[1;33m[!]\033[0m %s\n" "$*"; }
err(){ printf "\033[1;31m[-]\033[0m %s\n" "$*"; }
require_root(){ [ "$EUID" -ne 0 ] && { warn "Not root! Run with sudo."; exit 1; }; }

# ---------------- Banner ----------------
display_banner(){
  clear
  banner=(
"â–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•—â€ƒâ€ƒâ–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â€ƒâ€ƒâ–ˆâ–ˆâ•—â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘"
"â•šâ•â•â–ˆâ–ˆâ•”â•â€ƒâ€ƒâ–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â€ƒâ€ƒâ•šâ–ˆâ–ˆâ•—â–‘â–‘â–‘â–‘â–‘â–‘â–‘"
"â–‘â–‘â–ˆâ–ˆâ•”â•â–‘â€ƒâ€ƒâ•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â€ƒâ€ƒâ–‘â•šâ–ˆâ–ˆâ•—â–‘â–‘â–‘â–‘â–‘â–‘"
"â–‘â–ˆâ–ˆâ•”â•â–‘â–‘â€ƒâ€ƒâ–‘â•šâ•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–‘â–‘â€ƒâ€ƒâ–‘â–ˆâ–ˆâ•”â•â–‘â–‘â–‘â–‘â–‘â–‘"
"â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•—â€ƒâ€ƒâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–‘â–‘â€ƒâ€ƒâ–ˆâ–ˆâ•”â•â–‘â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—"
"â•šâ•â•â–‘â•šâ•â•â€ƒâ€ƒâ•šâ•â•â•â•â•â•â–‘â•šâ•â•â•â•â•â•â–‘â•šâ•â•â–‘â–‘â–‘â–‘â–‘â€ƒâ€ƒâ•šâ•â•â–‘â–‘â•šâ•â•â•šâ•â•"
  )
  echo -e "\033[1;36m"
  for line in "${banner[@]}"; do
    for ((i=0;i<${#line};i++)); do
      printf "%s" "${line:$i:1}"
      sleep "$BANNER_SPEED"
    done
    echo
  done
  echo -e "\033[0m"
  echo -e "\033[1;33mğŸŒŸ Pterodactyl Full Auto Installer ğŸŒŸ\033[0m"
  echo "================================================================"
}

# ---------------- OS Check ----------------
detect_os(){
  if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS_ID="${ID,,}"
    OS_VER="${VERSION_ID}"
    OS_PRETTY="${PRETTY_NAME}"
  else
    OS_ID="unknown"; OS_VER="0"; OS_PRETTY="Unknown"
  fi
  info "Detected OS: $OS_PRETTY"
  if [[ "$OS_ID" == "kali" && "$OS_VER" =~ 2025 ]]; then
    warn "âš ï¸  Kali 2025.x is not supported! Exiting."
    exit 1
  fi
  ok "OS supported."
}

# ---------------- MySQL Fix ----------------
fix_mysql_user(){
  info "Fixing MySQL user $DB_USER..."
  mysql -uroot -e "DROP USER IF EXISTS '$DB_USER'@'127.0.0.1'; CREATE USER '$DB_USER'@'127.0.0.1' IDENTIFIED BY '$DB_PASS'; CREATE DATABASE IF NOT EXISTS pterodactyl; GRANT ALL PRIVILEGES ON pterodactyl.* TO '$DB_USER'@'127.0.0.1'; FLUSH PRIVILEGES;"
  ok "MySQL user and DB ready."
}

# ---------------- Public IP ----------------
get_public_ip(){
  ip=$(curl -fsS https://ifconfig.me || curl -fsS https://ipinfo.io/ip || curl -fsS https://api.ipify.org || true)
  [ -z "$ip" ] && warn "Cannot detect public IP." || ok "Public IP: $ip"
  printf "%s" "$ip"
}

update_panel_env(){
  local ip="$1"
  local envs=("/var/www/pterodactyl/.env" "/var/www/panel/.env" "$HOME/pterodactyl/.env")
  for f in "${envs[@]}"; do
    [ -f "$f" ] || continue
    cp "$f" "$f.bak-$(date +%s)"
    grep -q "^APP_URL=" "$f" && sed -i "s|^APP_URL=.*|APP_URL=http://$ip|g" "$f" || echo "APP_URL=http://$ip" >> "$f"
    ok "Panel .env updated"
    return 0
  done
}

update_wings_config(){
  local ip="$1"
  local cfgs=("/etc/pterodactyl/config.yml" "/etc/pterodactyl/wings/config.yml")
  for f in "${cfgs[@]}"; do
    [ -f "$f" ] || continue
    sed -i "s|bind_address: .*|bind_address: $ip|g" "$f" || true
    ok "Wings config updated"
    return 0
  done
}

# ---------------- Firewall ----------------
setup_firewall(){
  info "Setting up firewall..."
  if command -v ufw >/dev/null 2>&1; then
    ufw allow 22/tcp
    ufw allow 80/tcp
    ufw allow 443/tcp
    ufw allow 8080/tcp
    ufw --force enable
    ok "Firewall configured"
  else
    warn "UFW not found, open ports manually"
  fi
}

# ---------------- TLS ----------------
setup_tls(){
  local domain="$1"
  [ -z "$domain" ] && return
  info "Installing certbot..."
  apt update -y && apt install -y certbot python3-certbot-nginx
  info "Issuing certificate for $domain..."
  certbot --nginx -d "$domain" --non-interactive --agree-tos -m admin@"$domain" || warn "TLS may have failed"
  ok "TLS attempted for $domain"
}

# ---------------- Main ----------------
require_root
display_banner
detect_os

# Run GitHub installer directly
bash <(curl -fsSL "$GITHUB_INSTALLER_URL") --yes

# Fix MySQL
fix_mysql_user

# Public IP update
PUB_IP=$(get_public_ip)
update_panel_env "$PUB_IP"
update_wings_config "$PUB_IP"

# TLS optional
DOMAIN=""
read -r -p "* Enter domain for HTTPS (leave blank to skip): " DOMAIN
[ -n "$DOMAIN" ] && setup_tls "$DOMAIN"

# Firewall
setup_firewall

# Clean
if [ "$DO_CLEAN" -eq 1 ]; then
  rm -f /tmp/ptero_lib.sh
  ok "Temporary files cleaned"
fi

echo
ok "Installation complete!"
echo "Panel + Wings ready. Access via IP: $PUB_IP"
echo "Check Cloudflare DNS: A record pointing to $PUB_IP"
