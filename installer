#!/bin/bash
# Pterodactyl Auto Installer (Full Final Version)
# Animated Banner + OS Check + Panel+Wings + TLS + Firewall + Auto IP

set -euo pipefail
IFS=$'\n\t'

# ---------- Config ----------
GITHUB_BASE_URL="https://raw.githubusercontent.com/pterodactyl-installer/pterodactyl-installer"
TMP_LIB="/tmp/ptero_lib.sh"
LOG_PATH="/var/log/pterodactyl_auto_installer.log"
BANNER_SPEED=0.002
AUTO_YES=0
DO_PANEL=1
DO_WINGS=1
DO_CLEAN=0
DO_PURGE=0
DB_USER="pterodactyl"
DB_PASS="PteroPass123!" # Change if needed

# ---------- Helpers ----------
info(){ printf "\033[1;34m[*]\033[0m %s\n" "$*"; }
ok(){ printf "\033[1;32m[+]\033[0m %s\n" "$*"; }
warn(){ printf "\033[1;33m[!]\033[0m %s\n" "$*"; }
err(){ printf "\033[1;31m[-]\033[0m %s\n" "$*"; }
confirm_or_die(){ [ "$AUTO_YES" -eq 1 ] && return 0; read -r -p "$1 [y/N]: " ans; [[ "$ans" =~ ^[Yy] ]] || { err "Aborted."; return 1; }; }
require_root(){ [ "$EUID" -ne 0 ] && { warn "Not root; sudo will be used where needed."; }; }

# ---------- Animated Banner ----------
display_banner(){
  clear
  banner=(
"â–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•—â€ƒâ€ƒâ–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â€ƒâ€ƒâ–ˆâ–ˆâ•—â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘"
"â•šâ•â•â–ˆâ–ˆâ•”â•â€ƒâ€ƒâ–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â€ƒâ€ƒâ•šâ–ˆâ–ˆâ•—â–‘â–‘â–‘â–‘â–‘â–‘â–‘"
"â–‘â–‘â–ˆâ–ˆâ•”â•â–‘â€ƒâ€ƒâ•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â€ƒâ€ƒâ–‘â•šâ–ˆâ–ˆâ•—â–‘â–‘â–‘â–‘â–‘â–‘"
"â–‘â–ˆâ–ˆâ•”â•â–‘â–‘â€ƒâ€ƒâ–‘â•šâ•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–‘â–‘â€ƒâ€ƒâ–‘â–ˆâ–ˆâ•”â•â–‘â–‘â–‘â–‘â–‘â–‘"
"â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•—â€ƒâ€ƒâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–‘â–‘â€ƒâ€ƒâ–ˆâ–ˆâ•”â•â–‘â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—"
"â•šâ•â•â–‘â•šâ•â•â€ƒâ€ƒâ•šâ•â•â•â•â•â•â–‘â•šâ•â•â•â•â•â•â–‘â•šâ•â•â–‘â–‘â–‘â–‘â–‘â€ƒâ€ƒâ•šâ•â•â–‘â–‘â•šâ•â•â•šâ•â•"
  )
  echo -e "\033[1;36m"
  for line in "${banner[@]}"; do
    for ((i=0;i<${#line};i++)); do
      printf "%s" "${line:$i:1}"
      sleep "$BANNER_SPEED"
    done
    echo
  done
  echo -e "\033[0m"
  echo -e "\033[1;33mğŸŒŸ Pterodactyl Auto Installer â€” Panel + Wings ğŸŒŸ\033[0m"
  echo "================================================================"
  echo
}

# ---------- Flags ----------
while (( $# )); do
  case "$1" in
    --yes|-y) AUTO_YES=1; shift ;;
    --no-panel) DO_PANEL=0; shift ;;
    --no-wings) DO_WINGS=0; shift ;;
    --clean) DO_CLEAN=1; shift ;;
    --purge) DO_PURGE=1; shift ;;
    --help|-h) echo "Usage: $0 [--yes] [--no-panel] [--no-wings] [--clean] [--purge]"; exit 0 ;;
    *) warn "Unknown option: $1"; shift ;;
  esac
done

# ---------- OS Check ----------
detect_os(){
  if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS_ID="${ID,,}"
    OS_VER="${VERSION_ID}"
    OS_PRETTY="${PRETTY_NAME}"
  else
    OS_ID="unknown"; OS_VER="0"; OS_PRETTY="Unknown"
  fi
  info "Detected OS: $OS_PRETTY"
  if [[ "$OS_ID" == "kali" && "$OS_VER" =~ 2025 ]]; then
    warn "âš ï¸  Kali 2025.x is not supported! Exiting."
    exit 1
  fi
  ok "OS Supported."
}

# ---------- Package helpers ----------
apt_install(){ DEBIAN_FRONTEND=noninteractive apt update -y && apt install -y "$@"; }
dnf_install(){ dnf install -y "$@"; }
yum_install(){ yum install -y "$@"; }
pacman_install(){ pacman -Syu --noconfirm "$@"; }

install_curl(){
  if ! command -v curl >/dev/null 2>&1; then
    warn "curl missing â€” installing..."
    case "$PKG" in
      apt) apt_install curl ca-certificates gnupg lsb-release apt-transport-https || true ;;
      dnf) dnf_install curl || true ;;
      yum) yum_install curl || true ;;
      pacman) pacman_install curl || true ;;
    esac
    ok "curl installed"
  else
    ok "curl present"
  fi
}

# ---------- MySQL fix ----------
fix_mysql_user(){
  info "Checking/creating MySQL user '$DB_USER'..."
  if ! command -v mysql >/dev/null 2>&1; then
    warn "mysql client not found. Install MariaDB/MySQL first."
    return
  fi
  mysql -uroot -e "DROP USER IF EXISTS '$DB_USER'@'127.0.0.1'; CREATE USER '$DB_USER'@'127.0.0.1' IDENTIFIED BY '$DB_PASS'; CREATE DATABASE IF NOT EXISTS pterodactyl; GRANT ALL PRIVILEGES ON pterodactyl.* TO '$DB_USER'@'127.0.0.1'; FLUSH PRIVILEGES;"
  ok "MySQL user '$DB_USER' ensured (1396 fixed) and DB created."
}

# ---------- IP & Config ----------
get_public_ip(){
  ip=$(curl -fsS https://ifconfig.me || curl -fsS https://ipinfo.io/ip || curl -fsS https://api.ipify.org || true)
  [ -z "$ip" ] && warn "Cannot detect public IP." || ok "Public IP detected: $ip"
  printf "%s" "$ip"
}

update_panel_env(){
  local ip="$1"
  local envs=("/var/www/pterodactyl/.env" "/var/www/panel/.env" "$HOME/pterodactyl/.env")
  for f in "${envs[@]}"; do
    [ -f "$f" ] || continue
    ok "Updating $f with APP_URL=http://$ip"
    cp "$f" "$f.bak-$(date +%s)" || true
    grep -q "^APP_URL=" "$f" && sed -i "s|^APP_URL=.*|APP_URL=http://$ip|g" "$f" || echo "APP_URL=http://$ip" >> "$f"
    return 0
  done
}

update_wings_config(){
  local ip="$1"
  local cfgs=("/etc/pterodactyl/config.yml" "/etc/pterodactyl/wings/config.yml")
  for f in "${cfgs[@]}"; do
    [ -f "$f" ] || continue
    ok "Updating Wings config $f with bind_address: $ip"
    sed -i "s|bind_address: .*|bind_address: $ip|g" "$f" || true
    return 0
  done
}

# ---------- TLS ----------
setup_tls(){
  local domain="$1"
  [ -z "$domain" ] && { warn "No domain for TLS"; return; }
  info "Installing certbot..."
  case "$PKG" in
    apt) apt_install certbot python3-certbot-nginx -y || true ;;
    dnf|yum) $PKG install -y certbot python3-certbot-nginx || true ;;
    pacman) pacman_install certbot python-certbot-nginx || true ;;
  esac
  info "Issuing certificate for $domain..."
  certbot --nginx -d "$domain" --non-interactive --agree-tos -m admin@"$domain" || warn "TLS may have failed"
  ok "TLS attempted for $domain"
}

# ---------- Firewall ----------
setup_firewall(){
  info "Configuring firewall..."
  if command -v ufw >/dev/null 2>&1; then
    ufw allow 22/tcp
    ufw allow 80/tcp
    ufw allow 443/tcp
    ufw allow 8080/tcp
    ufw --force enable
    ok "UFW rules set for SSH, HTTP, HTTPS, Wings"
  else
    warn "UFW not found; manually open ports 22,80,443,8080"
  fi
}

# ---------- Main ----------
require_root
display_banner
detect_os

# Package manager
if [[ "$OS_ID" =~ debian|ubuntu|kali ]]; then PKG="apt"; elif command -v dnf >/dev/null 2>&1; then PKG="dnf"; elif command -v yum >/dev/null 2>&1; then PKG="yum"; elif command -v pacman >/dev/null 2>&1; then PKG="pacman"; fi

install_curl

info "Installing dependencies..."
case "$PKG" in
  apt) apt_install mariadb-server nginx redis-server php-cli php-fpm php-mbstring php-xml php-bcmath php-zip unzip git curl composer -y || true ;;
  dnf|yum) $PKG install -y mariadb-server nginx redis php-cli php-fpm php-mbstring php-xml php-bcmath php-zip unzip git curl composer || true ;;
  pacman) pacman_install mariadb nginx redis php php-fpm php-mbstring php-xml php-bcmath php-zip unzip git curl composer || true ;;
esac

info "Ensuring Docker..."
if ! command -v docker >/dev/null 2>&1; then
  curl -fsSL https://get.docker.com | sh
  systemctl enable --now docker
fi
if ! docker compose version >/dev/null 2>&1; then [ "$PKG" = "apt" ] && apt_install docker-compose-plugin || true; fi

fix_mysql_user

[ -f "$TMP_LIB" ] && rm -f "$TMP_LIB"
curl -fsSL -o "$TMP_LIB" "$GITHUB_BASE_URL/master/lib/lib.sh" && source "$TMP_LIB" || true

[ "$DO_PANEL" -eq 1 ] && { info "Installing Panel..."; type run_ui >/dev/null 2>&1 && run_ui panel || warn "run_ui not found"; }
[ "$DO_WINGS" -eq 1 ] && { info "Installing Wings..."; type run_ui >/dev/null 2>&1 && run_ui wings || warn "run_ui not found"; }

PUB_IP=$(get_public_ip)
[ -n "$PUB_IP" ] && update_panel_env "$PUB_IP" && update_wings_config "$PUB_IP"

# TLS
[ "$AUTO_YES" -eq 0 ] && read -r -p "* Enter your domain for HTTPS (leave empty to skip TLS): " DOMAIN || DOMAIN=""
[ -n "$DOMAIN" ] && setup_tls "$DOMAIN"

setup_firewall

echo; ok "Installation finished. Public IP: $PUB_IP"
cat <<EOF
Cloudflare DNS instructions:

1) Login to Cloudflare dashboard.
2) Go to DNS of your domain.
3) Add an A record:
   - Type: A
   - Name: panel (or desired subdomain)
   - IPv4: $PUB_IP
   - Proxy status: DNS only (grey cloud recommended)
4) Use same IP in Panel APP_URL and Wings bind_address.

EOF

[ "$DO_CLEAN" -eq 1 ] && rm -f "$TMP_LIB" && ok "Temp files removed"
ok "All done. Check Panel (http://<IP or domain>) and Wings. Logs: $LOG_PATH"
